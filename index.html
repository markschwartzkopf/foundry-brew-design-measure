<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#111111" />
    <link rel="icon" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Brew Calc" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <title>Foundry Brew Calculator</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        row-gap: 0.5em;
      }
      #header {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      body:has(#header #mode input[value="design"]:checked) .only-measure {
        display: none;
      }
      #values {
        display: grid;
        grid-template-columns: repeat(
          auto-fit,
          minmax(13em, 1fr) minmax(6rem, max-content)
        );
        row-gap: 0.3em;
      }
      #values label {
        justify-self: end;
        text-align: right;
      }
      #values input {
        font-size: 1em;
      }
      #values input:disabled {
        border: none;
        background: none;
        color: inherit;
        -webkit-text-fill-color: currentColor;
        opacity: 1;
        font-size: 1em;
      }
      fieldset {
        border-radius: 0.5em;
      }
      label {
        cursor: pointer;
      }
      #chart {
        overflow-y: auto;
        overflow-x: hidden;
        width: 60vw;
        align-self: center;
        height: auto;
        display: block;
        aspect-ratio: 1333 / 1362;
      }
      #chart img {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="header">
      <fieldset id="mode">
        <legend>Mode</legend>
        <label
          ><input
            id="measure"
            type="radio"
            name="mode"
            value="measure"
            checked
          />
          Measure</label
        >
        <label><input type="radio" name="mode" value="design" /> Design</label>
      </fieldset>
    </div>
    <div id="values">
      <label for="dose">Dose (g):</label>
      <input id="dose" type="number" />
      <label for="brew-mass">Brew Mass (g):</label>
      <input id="brew-mass" type="number" />
      <label for="bev-mass">Beverage Mass (g):</label>
      <input id="bev-mass" type="number" />
      <label for="brew-ratio">Brew Ratio:</label>
      <input id="brew-ratio" type="text" />
      <label for="extraction">Extraction (%):</label>
      <input id="extraction" type="number" />
      <label for="tds">TDS (%):</label>
      <input id="tds" type="number" />
      <label for="basket-filter-mass" class="only-measure"
        >Basket + Filter (g):</label
      >
      <input id="basket-filter-mass" class="only-measure" type="number" />
      <label for="basket-filter-coffee-mass" class="only-measure"
        >Basket + Filter + Coffee (g):</label
      >
      <input
        id="basket-filter-coffee-mass"
        class="only-measure"
        type="number"
      />
      <label for="final-basket-mass" class="only-measure"
        >Final Basket (g):</label
      >
      <input id="final-basket-mass" class="only-measure" type="number" />
      <label for="empty-container-mass" class="only-measure"
        >Empty Container (g):</label
      >
      <input id="empty-container-mass" class="only-measure" type="number" />
      <label for="full-container-mass" class="only-measure"
        >Full Container (g):</label
      >
      <input id="full-container-mass" class="only-measure" type="number" />
      <label for="target-brew-gallons">Target Brew (gal):</label>
      <input id="target-brew-gallons" type="number" />
      <label for="target-brew-mass" class="only-measure"
        >Target Brew (g):</label
      >
      <input id="target-brew-mass" class="only-measure" type="number" />
      <label for="flow-rate-setting" class="only-measure"
        >Flow Rate Setting:</label
      >
      <input id="flow-rate-setting" class="only-measure" type="number" />
      <label for="corrected-flow-rate-setting" class="only-measure"
        >Corrected Flow Setting:</label
      >
      <input
        id="corrected-flow-rate-setting"
        class="only-measure"
        type="number"
      />
      <label for="absorption-ratio">Absorption Ratio:</label>
      <input id="absorption-ratio" type="number" />
    </div>
    <svg
      id="chart"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 60 57"
      font-family="system-ui, sans-serif"
      font-weight="600"
      font-size="1.4"
    >
      <defs>
        <clipPath id="clipBox" clipPathUnits="userSpaceOnUse">
          <rect x="14" y="0.90" width="12" height="0.8" />
        </clipPath>
      </defs>
      <rect width="60" height="57" fill="#fff" />
      <g id="translation" transform="translate(-48 105) scale(4 -60)">
        <rect
          x="14"
          y="0.9"
          width="12"
          height="0.8"
          fill="#eec"
          clip-path="url(#clipBox)"
        />
        <g
          id="liking-lines"
          fill="none"
          stroke-linecap="square"
          clip-path="url(#clipBox)"
        >
          <g id="cluster1" stroke="#B23" fill="#B234">
            <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M15.3 0.9C17.98 1.03 20.0 1.07 20.95 0.9"
            />
            <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M13.7 0.9C17.4 1.15 22.1 1.39 22.6 0.9"
            />
            <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M12.4 0.9C19 1.35 24.3 1.69 23.7 0.9"
            />
            <!-- <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M11.7 0.9C20.4 1.59 26.4 1.99 24.7 0.9"
            /> -->
          </g>
          <g id="cluster2" stroke="#17C" fill="#17C4">
            <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M26 1.07C24.3 1.26 24.8 1.35 26 1.46"
            />
            <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M26 0.97C22.5 1.27 21.4 1.33 26 1.555"
            />

            <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M14 1.3C14.9 1.4 14.9 1.5 14 1.625"
            />
            <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M14 1.185C17 1.39 16.3 1.5 14 1.74"
            />
            <path
              stroke-width="3"
              vector-effect="non-scaling-stroke"
              d="M14 1.11C19.7 1.38 18.7 1.43 14 1.81"
            />
          </g>
          <g id="both-clusters" stroke="#0f02" fill="#0f02">
            <ellipse
              stroke-width="3"
              transform="rotate(1.0 21.05 1.195)"
              rx="1.83"
              ry="0.08"
              cx="21.05"
              cy="1.195"
              vector-effect="non-scaling-stroke"
            />
            <!-- <ellipse stroke-width="3" transform="rotate(1.1 21.1 1.196)" rx="5.68" ry="0.248" cx="21.1" cy="1.196" vector-effect="non-scaling-stroke"/>
        <ellipse stroke-width="3" transform="rotate(1.07 21.05 1.197)" rx="7.76" ry="0.337" cx="21.05" cy="1.197" vector-effect="non-scaling-stroke"/> -->
          </g>
        </g>
        <path
          id="recipe-line"
          clip-path="url(#clipBox)"
          d="M12 0.7L28.6 1.7"
          fill="none"
          stroke="#0c0"
          stroke-width="5"
          vector-effect="non-scaling-stroke"
        />
        <ellipse
          id="brew-point"
          cx="20.17"
          cy="1.1922"
          rx="0.15"
          ry="0.01"
          stroke="currentColor"
          fill="#fff"
          clip-path="url(#clipBox)"
          vector-effect="non-scaling-stroke"
        />
        <path
          id="ticks"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          vector-effect="non-scaling-stroke"
          d="M14 1.65h0.15
    M14 1.60h0.15M14 1.55h0.15M14 1.50h0.15M14 1.45h0.15M14 1.40h0.15M14 1.35h0.15M14 1.30h0.15M14 1.25h0.15M14 1.20h0.15M14 1.15h0.15M14 1.10h0.15M14 1.05h0.15M14 1.00h0.15M14 0.95h0.15
    M15 0.90v0.013M16 0.90v0.013M17 0.90v0.013M18 0.90v0.013M19 0.90v0.013M20 0.90v0.013M21 0.90v0.013
    M22 0.90v0.013M23 0.90v0.013M24 0.90v0.013M25 0.90v0.013"
        />
        <rect
          x="14"
          y="0.9"
          width="12"
          height="0.8"
          fill="none"
          stroke="currentColor"
          stroke-width="5"
          vector-effect="non-scaling-stroke"
        />
      </g>
      <g
        id="tasting-notes"
        font-weight="bold"
        text-anchor="middle"
        dominant-baseline="middle"
      >
        <text x="13.2" y="18.5" font-size="1.7em">Berry</text>
        <text x="17.8" y="12.8" font-size="2.3em">Citrus</text>
        <text x="16.6" y="7.7" font-size="2.3em">Acid/Sour</text>
        <text x="48.6" y="13.1" font-size="2.1em">Roasted</text>
        <text x="24.5" y="49" font-size="1.8em">"Sweet"</text>
        <text x="46.7" y="47" font-size="1.8em">Black Tea</text>
        <text x="41" y="21.5" font-size="1.6em">Earthy</text>
      </g>
      <text
        x="3"
        y="27"
        font-size="1.4em"
        transform="rotate(-90 3 27)"
        text-anchor="middle"
        dominant-baseline="middle"
      >
        Total Dissolved Solids (%)
      </text>
      <g
        id="tds-labels"
        text-anchor="end"
        dominant-baseline="middle"
        fill="currentColor"
      >
        <text x="7.3" y="3">1.70</text>
        <text x="7.3" y="6">1.65</text>
        <text x="7.3" y="9">1.60</text>
        <text x="7.3" y="12">1.55</text>
        <text x="7.3" y="15">1.50</text>
        <text x="7.3" y="18">1.45</text>
        <text x="7.3" y="21">1.40</text>
        <text x="7.3" y="24">1.35</text>
        <text x="7.3" y="27">1.30</text>
        <text x="7.3" y="30">1.25</text>
        <text x="7.3" y="33">1.20</text>
        <text x="7.3" y="36">1.15</text>
        <text x="7.3" y="39">1.10</text>
        <text x="7.3" y="42">1.05</text>
        <text x="7.3" y="45">1.00</text>
        <text x="7.3" y="48">.95</text>
        <text x="7.3" y="51">.90</text>
      </g>
      <text
        x="36"
        y="55"
        font-size="1.4em"
        text-anchor="middle"
        dominant-baseline="middle"
      >
        Extraction (%)
      </text>
      <g
        id="extraction-labels"
        text-anchor="middle"
        dominant-baseline="middle"
        fill="currentColor"
      >
        <text x="8" y="52.5">14</text>
        <text x="12" y="52.5">15</text>
        <text x="16" y="52.5">16</text>
        <text x="20" y="52.5">17</text>
        <text x="24" y="52.5">18</text>
        <text x="28" y="52.5">19</text>
        <text x="32" y="52.5">20</text>
        <text x="36" y="52.5">21</text>
        <text x="40" y="52.5">22</text>
        <text x="44" y="52.5">23</text>
        <text x="48" y="52.5">24</text>
        <text x="52" y="52.5">25</text>
        <text x="56" y="52.5">26</text>
      </g>
    </svg>
    <script type="module">// src/brew-calc.ts
var doseInput = document.getElementById("dose");
doseInput.onchange = () => {
  const dose = parseFloat(doseInput.value) || 0;
  updateState({ dose });
};
var brewMassInput = document.getElementById("brew-mass");
var bevMassInput = document.getElementById("bev-mass");
var brewRatioInput = document.getElementById(
  "brew-ratio"
);
var extInput = document.getElementById("extraction");
var tdsInput = document.getElementById("tds");
var basketFilterMassInput = document.getElementById(
  "basket-filter-mass"
);
var basketFilterCoffeeMassInput = document.getElementById(
  "basket-filter-coffee-mass"
);
var finalBasketMassInput = document.getElementById(
  "final-basket-mass"
);
var emptyContainerMassInput = document.getElementById(
  "empty-container-mass"
);
var fullContainerMassInput = document.getElementById(
  "full-container-mass"
);
var targetBrewGallonsInput = document.getElementById(
  "target-brew-gallons"
);
var targetBrewMassInput = document.getElementById(
  "target-brew-mass"
);
var flowRateSettingInput = document.getElementById(
  "flow-rate-setting"
);
var correctedFlowRateSettingInput = document.getElementById(
  "corrected-flow-rate-setting"
);
var absorptionRatioInput = document.getElementById(
  "absorption-ratio"
);
var designInputs = [
  brewMassInput,
  extInput,
  tdsInput,
  targetBrewGallonsInput,
  absorptionRatioInput
];
var measureInputs = [
  doseInput,
  tdsInput,
  basketFilterMassInput,
  finalBasketMassInput,
  emptyContainerMassInput,
  fullContainerMassInput,
  targetBrewGallonsInput,
  targetBrewMassInput,
  flowRateSettingInput
];
var allInputs = [
  ...designInputs,
  ...measureInputs,
  bevMassInput,
  brewRatioInput,
  basketFilterCoffeeMassInput,
  correctedFlowRateSettingInput
];
var inputsMap = {
  dose: doseInput,
  brewMass: brewMassInput,
  bevMass: bevMassInput,
  brewRatio: brewRatioInput,
  ext: extInput,
  tds: tdsInput,
  basketFilterMass: basketFilterMassInput,
  basketFilterCoffeeMass: basketFilterCoffeeMassInput,
  finalBasketMass: finalBasketMassInput,
  emptyContainerMass: emptyContainerMassInput,
  fullContainerMass: fullContainerMassInput,
  targetBrewGallons: targetBrewGallonsInput,
  targetBrewMass: targetBrewMassInput,
  flowRateSetting: flowRateSettingInput,
  correctedFlowRateSetting: correctedFlowRateSettingInput,
  absorptionRatio: absorptionRatioInput
};
var modeFs = document.getElementById("mode");
var recipeLine = document.getElementById(
  "recipe-line"
);
var brewPoint = document.getElementById(
  "brew-point"
);
var state = {
  mode: "design",
  dose: 200,
  brewMass: 3785,
  bevMass: 3405,
  brewRatio: 19.9,
  ext: 21.8,
  tds: 1.22,
  basketFilterMass: null,
  basketFilterCoffeeMass: null,
  finalBasketMass: null,
  emptyContainerMass: null,
  fullContainerMass: null,
  targetBrewGallons: null,
  targetBrewMass: null,
  flowRateSetting: null,
  correctedFlowRateSetting: null,
  absorptionRatio: 2.1
};
function inputChangeHandler(key, input) {
  console.log(`Input change: ${key}`);
  let value = parseFloat(input.value);
  if (isNaN(value)) value = null;
  updateState({ [key]: value });
}
for (const key in inputsMap) {
  const typedKey = key;
  const input = inputsMap[typedKey];
  input.onchange = () => {
    inputChangeHandler(typedKey, input);
  };
}
targetBrewGallonsInput.onchange = () => {
  if (state.mode === "measure") {
    let value = parseFloat(targetBrewGallonsInput.value);
    if (isNaN(value)) value = null;
    targetBrewMassInput.value = value === null ? "" : String(value * 3785);
    updateState({
      targetBrewGallons: value,
      targetBrewMass: value === null ? null : value * 3785
    });
  } else {
    let value = parseFloat(targetBrewGallonsInput.value);
    if (isNaN(value)) value = null;
    brewMassInput.value = value === null ? "" : String(value * 3785);
    targetBrewMassInput.value = value === null ? "" : String(value * 3785);
    updateState({
      targetBrewGallons: value,
      brewMass: value === null ? null : value * 3785,
      targetBrewMass: value === null ? null : value * 3785
    });
  }
};
targetBrewMassInput.onchange = () => {
  if (state.mode === "measure") {
    let value = parseFloat(targetBrewMassInput.value);
    if (isNaN(value)) value = null;
    targetBrewGallonsInput.value = value === null ? "" : (value / 3785).toPrecision(3);
    updateState({
      targetBrewMass: value,
      targetBrewGallons: value === null ? null : Number((value / 3785).toPrecision(3))
    });
  } else inputChangeHandler("targetBrewMass", targetBrewMassInput);
};
brewMassInput.onchange = () => {
  if (state.mode === "design") {
    let value = parseFloat(brewMassInput.value);
    if (isNaN(value)) value = null;
    targetBrewGallonsInput.value = value === null ? "" : (value / 3785).toPrecision(3);
    updateState({
      brewMass: value,
      targetBrewGallons: value === null ? null : Number((value / 3785).toPrecision(3))
    });
  }
};
function updateState(newStatePartial) {
  const newState = { ...state, ...newStatePartial };
  if (newState.mode === "design") {
    if (newState.tds && newState.ext && newState.brewMass && newState.absorptionRatio) {
      newState.dose = newState.tds / 100 * newState.brewMass / (newState.ext / 100 + newState.tds / 100 * newState.absorptionRatio);
      newState.dose = Number(newState.dose.toPrecision(3));
    } else newState.dose = null;
    if (newState.dose && newState.brewMass && newState.absorptionRatio) {
      newState.bevMass = newState.brewMass - newState.dose * newState.absorptionRatio;
      newState.bevMass = Math.round(newState.bevMass);
    } else newState.bevMass = null;
    if (newState.dose && newState.brewMass) {
      newState.brewRatio = newState.brewMass / newState.dose;
      newState.brewRatio = Math.round(newState.brewRatio * 10) / 10;
    } else newState.brewRatio = null;
    if (newState.targetBrewGallons !== null) {
      newState.targetBrewMass = newState.targetBrewGallons * 3785;
    }
  } else if (newState.mode === "measure") {
    if (newState.emptyContainerMass !== null && newState.fullContainerMass !== null) {
      newState.bevMass = newState.fullContainerMass - newState.emptyContainerMass;
      newState.bevMass = Math.round(newState.bevMass);
    } else newState.bevMass = null;
    if (newState.dose !== null && newState.basketFilterMass !== null) {
      newState.basketFilterCoffeeMass = newState.dose + newState.basketFilterMass;
    } else newState.basketFilterCoffeeMass = null;
    if (newState.bevMass !== null && newState.finalBasketMass !== null && newState.basketFilterCoffeeMass !== null) {
      newState.brewMass = newState.bevMass + (newState.finalBasketMass - newState.basketFilterCoffeeMass);
      newState.brewMass = Math.round(newState.brewMass);
    } else newState.brewMass = null;
    if (newState.dose !== null && newState.brewMass !== null) {
      newState.brewRatio = newState.brewMass / newState.dose;
      newState.brewRatio = Math.round(newState.brewRatio * 100) / 100;
    } else newState.brewRatio = null;
    if (newState.bevMass !== null && newState.tds !== null && newState.finalBasketMass !== null && newState.basketFilterCoffeeMass !== null && newState.dose !== null) {
      const coffeeInBev = newState.tds / 100 * newState.bevMass;
      const waterLeftInBasket = newState.finalBasketMass - newState.basketFilterCoffeeMass + coffeeInBev;
      newState.absorptionRatio = waterLeftInBasket / newState.dose;
      newState.absorptionRatio = Math.round(newState.absorptionRatio * 10) / 10;
    } else newState.absorptionRatio = null;
    if (newState.tds !== null && newState.bevMass !== null && newState.dose !== null) {
      newState.ext = newState.tds * (newState.bevMass / newState.dose);
      newState.ext = Math.round(newState.ext * 100) / 100;
    } else newState.ext = null;
    if (newState.flowRateSetting !== null && newState.brewMass !== null && newState.targetBrewMass) {
      newState.correctedFlowRateSetting = newState.flowRateSetting * (newState.brewMass / newState.targetBrewMass);
      newState.correctedFlowRateSetting = Math.round(newState.correctedFlowRateSetting * 100) / 100;
    } else newState.correctedFlowRateSetting = null;
  }
  const json = JSON.stringify(newState);
  const encoded = encodeURIComponent(json);
  history.replaceState(null, "", `#${encoded}`);
  updateUI();
}
function updateUI() {
  const hash = location.hash.slice(1);
  if (!hash) {
    updateState({});
    return;
  } else {
    try {
      const decoded = decodeURIComponent(hash);
      const parsed = JSON.parse(decoded);
      state = { ...state, ...parsed };
    } catch (e) {
      console.error("Error parsing state from URL hash:", e);
      updateState({});
      return;
    }
  }
  if (state.bevMass !== null && state.dose !== null) {
    const y1 = 0.75;
    const y2 = 1.75;
    const x1 = y1 * (state.bevMass / state.dose);
    const x2 = y2 * (state.bevMass / state.dose);
    recipeLine.setAttribute("d", `M${x1} ${y1}L${x2} ${y2}`);
    console.log(recipeLine.getAttribute("d"));
    recipeLine.style.display = "block";
  } else recipeLine.style.display = "none";
  if (state.ext !== null && state.tds !== null) {
    brewPoint.setAttribute("cx", String(state.ext));
    brewPoint.setAttribute("cy", String(state.tds));
    brewPoint.style.display = "block";
  } else brewPoint.style.display = "none";
  if (state.mode === "design") {
    modeFs.querySelector(
      'input[name="mode"][value="design"]'
    ).checked = true;
  } else {
    modeFs.querySelector(
      'input[name="mode"][value="measure"]'
    ).checked = true;
  }
  for (const key in inputsMap) {
    const typedKey = key;
    const input = inputsMap[typedKey];
    if (typedKey === "brewRatio") {
      input.value = state[typedKey] === null ? "" : `${state[typedKey]}:1`;
    } else
      input.value = state[typedKey] === null ? "" : String(state[typedKey]);
  }
  allInputs.forEach((input) => {
    if (state.mode === "design") {
      if (designInputs.includes(input)) {
        input.disabled = false;
      } else {
        input.disabled = true;
      }
    } else if (measureInputs.includes(input)) {
      input.disabled = false;
    } else {
      input.disabled = true;
    }
  });
}
modeFs.onchange = () => {
  const mode = modeFs.querySelector(
    'input[name="mode"]:checked'
  ).value;
  updateState({ mode });
};
updateUI();
</script>
  </body>
</html>

